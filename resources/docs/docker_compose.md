
# Local Development with Docker Compose

> **_IMPORTANT:_** this documentation requires familiarity with [Running the Server](https://github.com/slateci/slate-client-server/blob/master/resources/docs/server_running.md) and [Running the server tests](https://github.com/slateci/slate-client-server/blob/master/resources/docs/server_testing.md).

## Requirements

### Install Docker/Compose

Install [Docker](https://docs.docker.com/get-docker/) and [docker-compose](https://docs.docker.com/compose/install/) for developing, managing, and running OCI containers on your system.

## Build and Run the SLATE API

If there are build artifacts in `${PWD}/build` not generated by `docker-compose` remove them to prevent errors:

```shell
[your@localmachine]$ rm -rf ${PWD}/build/.*
```

* The `cmake` process builds against Centos7 which can cause issues for artifacts already generated by other host operating systems.

Next execute the `up` command below to:

1. Start a local DynamoDB instance.
1. Start a local Rancher K3s instance (Kubernetes).
1. Start a utility container with useful pre-installed tools like `helm`, `kubectl`, `slate`, and more.
1. Make the `slate-service` binary from the source on your machine and output to `${PWD}/build`.
1. Run `slate-service --config /path/to/slate.conf`

```shell
[your@localmachine]$ docker-compose up
...
slate_api          | [ 97%] Built target test-secret-fetching
slate_api          | [ 97%] Linking CXX executable tests/test-instance-info-fetching
slate_api          | [ 98%] Built target test-instance-info-fetching
slate_api          | [ 99%] Linking CXX executable tests/test-instance-deletion
slate_api          | [100%] Built target test-instance-deletion
slate_api          | Starting slate-service...
slate_api          | INFO: [2022-Apr-12 21:35:58.344379 UTC] (TID 140562998134912) Database URL is http://slate_database:8000
slate_api          | INFO: [2022-Apr-12 21:35:58.344465 UTC] (TID 140562998134912) Service port is 18080
slate_api          | INFO: [2022-Apr-12 21:35:58.344540 UTC] (TID 140562998134912) Using 32 web server threads
...
...
slate_rancher      | I0412 21:35:58.506734      32 scope.go:111] "RemoveContainer" containerID="0bc5055e76501bafa3c01da5aa3c8ea06b4eb609778bc9352684cc03225d308b"
...
...
```

* Re-execute `docker-compose up` to make `slate-service` as many times as needed.
* The `${PWD}/resources/docker/Dockerfile` is a multi-stage file where `docker-compose` targets its `local-stage`. For more information see [Docker: Use multi-stage builds](https://docs.docker.com/develop/develop-images/multistage-build/).

## Seed Sample Data

If desired, attach to the `slate_utility` container and seed the DynamoDB instance with sample data:

```shell
[your@localmachine]$ docker exec -it slate_utility bash
[root@8f029675e71c /]# . /slate/resources/docker/scripts/seed-sample-data.sh
Setting up local Rancher K3s...
Property "clusters.default.server" set.
Seeding sample data...
Successfully created group my-group with ID group_ShWq5Va8h_k
Checking NRP-controller status...
...
...
=============================================================
Default Group: my-group
Default Cluster: my-cluster
```

View the newly applied sample data:

```shell
[root@8f029675e71c slate]# slate cluster list
Name       Admin    ID                 
my-cluster my-group cluster_2ogEx1tNpWI
```

## Test the `slate-service` Binary

> **_IMPORTANT:_** this currently does not work. Debugging...

Attach to the `slate_api` container and run `ctest`:

```shell
[your@localmachine]$ docker exec -it slate_api bash
[root@414b1f4cec4a /]# . /slate/resources/docker/scripts/ctest.sh
Setting up local Rancher K3s...
Property "clusters.default.server" set.
Running unit tests...
Test project /slate/build
Starting Dynamo server
Installing federation role
Installing federation controller
Done initializing kubernetes
Preparing local helm repository
Starting local helm server
"local" has been added to your repositories
Initialization done
      Start  1: test-user-listing
 1/49 Test  #1: test-user-listing ...........................***Passed    0.02 sec
...
...
```

## Teardown

In the terminal session running `docker-compose up` type `CTRL + C` to stop all existing containers. Finally teardown using one of the following options:

* Leave the associated images, volumes, and networks on your machine by executing:

  ```shell
  [your@localmachine]$ docker-compose down
  ```

  **Result:** re-running `docker-compose up` will still rebuild `slate-service` but all other services will restart with their existing states.

* Completely remove everything:

  ```shell
  [your@localmachine]$ docker-compose down --rmi all
  [your@localmachine]$ docker volume rm slate-client-server_dynamodb_data slate-client-server_dynamodb_lib slate-client-server_kubernetes
  ```
  
  or if there are no other important volumes:

  ```shell
  [your@localmachine]$ docker volume prune
  ```
  
  **Result:** re-running `docker-compose up` will start everything from scratch.
